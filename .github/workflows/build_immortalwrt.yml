name: ğŸš€ ç¼–è¯‘ immortalwrt

on:
  workflow_dispatch:
    inputs:
      owner:
        description: "openWRT ä»“åº“çš„æ‹¥æœ‰è€…"
        required: true
        default: "immortalwrt"
      repo:
        description: "openWRT ä»“åº“çš„åå­—" 
        required: true
        default: "immortalwrt"
      branch:
        description: "openWRT ä»“åº“çš„åˆ†æ”¯"
        required: true
        default: "openwrt-21.02"
      multithreading:
        description: "å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        type: boolean
        default: true
      ssh:
        description: "ä½¿ç”¨sshè¿æ¥åˆ°ç¼–è¯‘ç¯å¢ƒ"
        type: boolean
        default: false
      isFiles:
        description: "ä½¿ç”¨fileså¤§æ³•"
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    name: ğŸš€ ç¼–è¯‘ ImmortalWRT
    
    steps:
      - name: æ£€æŸ¥åˆå§‹ç£ç›˜ç©ºé—´
        run: |
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´çŠ¶æ€ ==="
          df -h
          echo "========================="

      - name: åŸºç¡€ç³»ç»Ÿæ¸…ç†
        run: |
          echo "æ‰§è¡ŒåŸºç¡€æ¸…ç†..."
          sudo apt autoremove -y
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /usr/local/lib/android /opt/hostedtoolcache/CodeQL /usr/share/dotnet 2>/dev/null || true
          docker system prune -af 2>/dev/null || true

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential ccache cmake curl flex gawk gettext \
            git libncurses-dev libssl-dev python3 python3-pip \
            rsync subversion unzip wget zlib1g-dev \
            libjson-c-dev libubox-dev libubus-dev libpcre2-dev \
            libmbedtls-dev libsodium-dev libc-ares-dev \
            gcc-multilib g++-multilib pkg-config autoconf automake libtool

      - name: å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: å…‹éš† OpenWRT ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          ref: ${{ inputs.branch }}
          path: openWRT

      - name: å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          if [ -f .config ]; then
            cp .config openWRT/
            echo "é…ç½®æ–‡ä»¶å·²å¤åˆ¶"
          else
            echo "æœªæ‰¾åˆ° .config æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          
          if [ -f diy.sh ]; then
            cp diy.sh openWRT/
            chmod +x openWRT/diy.sh
            echo "diy.sh å·²å¤åˆ¶å¹¶èµ‹äºˆæ‰§è¡Œæƒé™"
          fi

      - name: å¤åˆ¶ files ç›®å½•
        if: ${{ inputs.isFiles }}
        run: |
          if [ -d files ]; then
            cp -r files openWRT/
            echo "files ç›®å½•å·²å¤åˆ¶"
          else
            echo "æœªæ‰¾åˆ° files ç›®å½•"
          fi

      - name: è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
        working-directory: openWRT
        run: |
          if [ -f diy.sh ]; then
            echo "æ‰§è¡Œ diy.sh..."
            ./diy.sh
          else
            echo "æœªæ‰¾åˆ° diy.shï¼Œè·³è¿‡æ‰§è¡Œ"
          fi

      - name: æ›´æ–°å’Œå®‰è£… feeds
        working-directory: openWRT
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: é…ç½®æ£€æŸ¥
        working-directory: openWRT
        run: |
          if [ -f .config ]; then
            echo "ä½¿ç”¨ç°æœ‰é…ç½®..."
            make defconfig
          else
            echo "ç”Ÿæˆé»˜è®¤é…ç½®..."
            make defconfig
          fi

      - name: SSH è°ƒè¯•ä¼šè¯
        if: ${{ inputs.ssh }}
        uses: csexton/debugger-action@master
        timeout-minutes: 15

      - name: ç¼–è¯‘å·¥å…·é“¾
        working-directory: openWRT
        run: |
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make tools/compile -j$(nproc) V=0
          make toolchain/compile -j$(nproc) V=0

      - name: å¤šçº¿ç¨‹ç¼–è¯‘
        if: ${{ inputs.multithreading }}
        working-directory: openWRT
        run: make -j$(nproc) V=s

      - name: å•çº¿ç¨‹ç¼–è¯‘  
        if: ${{ !inputs.multithreading }}
        working-directory: openWRT
        run: make -j1 V=s

      - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
        working-directory: openWRT
        run: |
          echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥äº§ç‰©..."
          find bin -name "*.bin" -o -name "*.img" | head -10
          echo "äº§ç‰©æ€»å¤§å°:"
          du -sh bin/targets

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-build-${{ github.run_number }}
          path: |
            openWRT/bin/targets/**/*
            openWRT/bin/packages/**/*
          retention-days: 7
