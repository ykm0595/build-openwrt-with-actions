name: ðŸš€ ç¼–è¯‘ ImmortalWrt for SL-3000 (æ— USBç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      skip_kmods:
        description: "è·³è¿‡å†…æ ¸æ¨¡å—ç¼–è¯‘ï¼ˆèŠ‚çœç©ºé—´ï¼‰"
        type: boolean
        default: false
      minimal_build:
        description: "æœ€å°åŒ–ç¼–è¯‘ï¼ˆä»…æ ¸å¿ƒ+Dockerï¼‰"
        type: boolean
        default: true
      clean_build:
        description: "å®Œå…¨æ¸…ç†æž„å»º"
        type: boolean
        default: false

env:
  REPO_URL: "https://github.com/immortalwrt/immortalwrt"
  BRANCH: "openwrt-24.10"
  TZ: "Asia/Shanghai"

jobs:
  build:
    runs-on: ubuntu-22.04
    name: ðŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶ (æ— USBç‰ˆ)
    timeout-minutes: 180
    
    steps:
      - name: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
          df -h
          echo "=== å·¥ä½œç›®å½•æ£€æŸ¥ ==="
          pwd
          ls -la
          echo "==================="

      - name: æ·±åº¦ç£ç›˜æ¸…ç†
        run: |
          echo "æ‰§è¡Œæ·±åº¦ç£ç›˜æ¸…ç†..."
          sudo apt autoremove -y
          sudo apt autoclean
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /usr/local/lib/android /opt/hostedtoolcache/CodeQL /usr/share/dotnet 2>/dev/null || true
          sudo rm -rf /opt/ghc /opt/hostedtoolcache/PyPy /opt/microsoft 2>/dev/null || true
          docker system prune -af 2>/dev/null || true
          sudo rm -rf /var/lib/docker/* 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* /var/cache/* ~/.cache/*
          sudo journalctl --vacuum-time=1h 2>/dev/null || true
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null || true
          echo "æ¸…ç†å®Œæˆ"

      - name: å®‰è£…ç²¾ç®€ç‰ˆä¾èµ–
        run: |
          echo "å®‰è£…æœ€å°åŒ–ç¼–è¯‘ä¾èµ–..."
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential ccache cmake curl flex gawk gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync subversion unzip wget zlib1g-dev \
            libjson-c-dev libubox-dev libubus-dev libpcre2-dev \
            libmbedtls-dev libsodium-dev libc-ares-dev \
            gcc-multilib g++-multilib pkg-config autoconf automake libtool \
            device-tree-compiler lld llvm ninja-build upx-ucl zstd \
            file gperf help2man texinfo xsltproc
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: è®¾ç½®ccacheä¼˜åŒ–
        run: |
          ccache -M 1G 2>/dev/null || true
          git config --global pack.windowMemory 50m
          git config --global pack.packSizeLimit 50m
          git config --global core.compression 9

      - name: å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æ£€æŸ¥å½“å‰ç›®å½•çŠ¶æ€
        run: |
          echo "=== å…‹éš†åŽç›®å½•çŠ¶æ€ ==="
          pwd
          ls -la
          echo "===================="

      - name: æµ…å…‹éš† ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ env.BRANCH }}
          path: openwrt
          fetch-depth: 1

      - name: éªŒè¯æºç ç›®å½•
        run: |
          echo "=== éªŒè¯ openwrt ç›®å½• ==="
          if [ -d "openwrt" ]; then
            echo "âœ… openwrt ç›®å½•å­˜åœ¨"
            ls -la openwrt/
            echo "ç›®å½•å¤§å°:"
            du -sh openwrt
          else
            echo "âŒ openwrt ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºç›®å½•"
            mkdir -p openwrt
          fi
          echo "===================="

      - name: ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
          df -h
          AVAILABLE=$(df / --output=avail | tail -1)
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE}KB"
          if [ $AVAILABLE -lt 8000000 ]; then
            echo "è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼ ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
          else
            echo "ç£ç›˜ç©ºé—´å……è¶³"
          fi

      - name: åº”ç”¨æ— USBé…ç½®
        run: |
          echo "åº”ç”¨æ— USBé…ç½®..."
          # ç¡®ä¿ openwrt ç›®å½•å­˜åœ¨
          mkdir -p openwrt
          # ä½¿ç”¨é€è¡Œå†™å…¥é¿å…å¤šè¡Œå­—ç¬¦ä¸²é—®é¢˜
          {
            echo "CONFIG_TARGET_mediatek=y"
            echo "CONFIG_TARGET_mediatek_filogic=y"
            echo "CONFIG_TARGET_mediatek_filogic_DEVICE_sl_3000-emmc=y"
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
            echo "CONFIG_TARGET_ROOTFS_EXT4FS=n"
            echo "CONFIG_TARGET_KERNEL_PARTSIZE=32"
            echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024"
            echo "CONFIG_PACKAGE_block-mount=y"
            echo "CONFIG_PACKAGE_uhttpd=y"
            echo "CONFIG_PACKAGE_fstools=y"
            echo "CONFIG_PACKAGE_procd=y"
            echo "CONFIG_PACKAGE_uci=y"
            echo "CONFIG_PACKAGE_ubus=y"
            echo "CONFIG_PACKAGE_ubox=y"
            echo "CONFIG_PACKAGE_kmod-mt7915e=y"
            echo "CONFIG_PACKAGE_kmod-mt7916-firmware=y"
            echo "CONFIG_PACKAGE_kmod-mtk-esw-rt3050=y"
            echo "CONFIG_PACKAGE_kmod-mtk-hnat=y"
            echo "CONFIG_PACKAGE_kmod-mtk-ppe=y"
            echo "CONFIG_PACKAGE_kmod-phy-mediatek-ge-soc=y"
            echo "CONFIG_PACKAGE_dnsmasq=y"
            echo "CONFIG_PACKAGE_dnsmasq-full=y"
            echo "CONFIG_PACKAGE_firewall=y"
            echo "CONFIG_PACKAGE_odhcpd=y"
            echo "CONFIG_PACKAGE_odhcp6c=y"
            echo "CONFIG_PACKAGE_iptables=y"
            echo "CONFIG_PACKAGE_ip6tables=y"
            echo "CONFIG_PACKAGE_docker=y"
            echo "CONFIG_PACKAGE_dockerd=y"
            echo "CONFIG_PACKAGE_docker-compose=y"
            echo "CONFIG_PACKAGE_containerd=y"
            echo "CONFIG_PACKAGE_runc=y"
            echo "CONFIG_PACKAGE_libdevmapper=y"
            echo "CONFIG_PACKAGE_libltdl=y"
            echo "CONFIG_PACKAGE_libnetwork=y"
            echo "CONFIG_PACKAGE_libstdcpp=y"
            echo "CONFIG_PACKAGE_kmod-dm=y"
            echo "CONFIG_PACKAGE_kmod-br-netfilter=y"
            echo "CONFIG_PACKAGE_kmod-veth=y"
            echo "CONFIG_PACKAGE_kmod-ipt-core=y"
            echo "CONFIG_PACKAGE_kmod-ipt-nat=y"
            echo "CONFIG_PACKAGE_kmod-nf-conntrack=y"
            echo "CONFIG_PACKAGE_kmod-nf-nat=y"
            echo "CONFIG_PACKAGE_kmod-fuse=y"
            echo "CONFIG_PACKAGE_kmod-loop=y"
            echo "CONFIG_PACKAGE_luci=y"
            echo "CONFIG_PACKAGE_luci-ssl-openssl=y"
            echo "CONFIG_PACKAGE_luci-app-dockerman=y"
            echo "CONFIG_PACKAGE_luci-app-firewall=y"
            echo "CONFIG_PACKAGE_luci-theme-bootstrap=y"
            echo "CONFIG_PACKAGE_curl=y"
            echo "CONFIG_PACKAGE_bash=y"
            echo "CONFIG_PACKAGE_htop=y"
            echo "CONFIG_PACKAGE_python3=y"
            echo "CONFIG_PACKAGE_python3-pip=y"
            echo "CONFIG_PACKAGE_kmod-fs-ext4=y"
            echo "CONFIG_PACKAGE_kmod-fs-vfat=y"
            echo "CONFIG_PACKAGE_kmod-fs-squashfs=y"
            echo "CONFIG_CCACHE=y"
            echo "CONFIG_BUILD_LOG=y"
          } > openwrt/.config
          echo "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"

      - name: æ›´æ–°feeds
        id: update-feeds
        run: |
          echo "æ›´æ–°feeds..."
          if [ -d "openwrt" ]; then
            cd openwrt
            ./scripts/feeds update -a
            ./scripts/feeds install -a
            echo "feedsæ›´æ–°å®Œæˆ"
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: é…ç½®æ£€æŸ¥
        id: config-check
        run: |
          echo "åº”ç”¨é…ç½®ä¼˜åŒ–..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make defconfig
            ./scripts/diffconfig.sh > diffconfig.txt
            echo "é…ç½®ä¼˜åŒ–å®Œæˆ"
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ä¸‹è½½æºç 
        id: download-sources
        run: |
          echo "ä¸‹è½½æºç ..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make download -j2 V=0 || make download -j1 V=0
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç¼–è¯‘å·¥å…·é“¾
        id: build-toolchain
        run: |
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make tools/compile -j1 V=0
            make toolchain/compile -j1 V=0
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ
        id: build-core
        run: |
          echo "ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ..."
          if [ -d "openwrt" ]; then
            cd openwrt
            if [ "${{ inputs.minimal_build }}" = "true" ]; then
              echo "ä½¿ç”¨æœ€å°åŒ–ç¼–è¯‘æ¨¡å¼..."
              make -j2 V=s
            else
              make -j$(nproc) V=s
            fi
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç¼–è¯‘Dockerç»„ä»¶
        id: build-docker
        if: ${{ !inputs.skip_kmods }}
        run: |
          echo "ç¼–è¯‘Dockerç»„ä»¶..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make package/feeds/packages/docker/compile V=s -j2
            make package/feeds/packages/dockerd/compile V=s -j2
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç©ºé—´ç›‘æŽ§
        run: |
          echo "ç¼–è¯‘ä¸­ç£ç›˜ç©ºé—´:"
          df -h
          echo "å½“å‰ç›®å½•çŠ¶æ€:"
          pwd
          ls -la
          if [ -d "openwrt" ]; then
            echo "openwrtç›®å½•å­˜åœ¨ï¼Œå¤§å°:"
            du -sh openwrt
          else
            echo "è­¦å‘Š: openwrtç›®å½•ä¸å­˜åœ¨"
          fi

      - name: æ¸…ç†ä¸­é—´æ–‡ä»¶
        if: always()
        run: |
          echo "æ¸…ç†ä¸­é—´æ–‡ä»¶..."
          if [ -d "openwrt" ]; then
            echo "è¿›å…¥openwrtç›®å½•æ¸…ç†..."
            cd openwrt
            if [ -d "build_dir" ]; then
              find build_dir -name "*.o" -delete 2>/dev/null || true
              find build_dir -name "*.a" -delete 2>/dev/null || true
              echo "build_diræ¸…ç†å®Œæˆ"
            else
              echo "build_dirä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
            fi
            rm -rf logs/* tmp/* 2>/dev/null || true
            echo "ä¸­é—´æ–‡ä»¶æ¸…ç†å®Œæˆ"
          else
            echo "openwrtç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†ä¸­é—´æ–‡ä»¶"
          fi

      - name: éªŒè¯ç¼–è¯‘ç»“æžœ
        id: verify-build
        run: |
          echo "æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
          if [ -d "openwrt" ]; then
            cd openwrt
            if find bin/targets -name "*sl_3000*" 2>/dev/null | grep -q .; then
              echo "âœ… SL-3000å›ºä»¶ç¼–è¯‘æˆåŠŸ"
              find bin/targets -name "*sl_3000*.bin" -exec echo "å›ºä»¶: {}" \;
            else
              echo "âŒ æœªæ‰¾åˆ°SL-3000å›ºä»¶"
              echo "å½“å‰ç›®å½•å†…å®¹:"
              ls -la bin/targets/ 2>/dev/null || echo "bin/targetsç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ openwrtç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯ç¼–è¯‘ç»“æžœ"
            exit 1
          fi

      - name: æœ€ç»ˆç©ºé—´æŠ¥å‘Š
        run: |
          echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
          df -h
          echo "å·¥ä½œç›®å½•å†…å®¹:"
          pwd
          ls -la
          if [ -d "openwrt" ]; then
            echo "openwrtç›®å½•å†…å®¹:"
            ls -la openwrt/bin/ 2>/dev/null || echo "openwrt/binç›®å½•ä¸å­˜åœ¨"
          fi

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-nousb-${{ github.run_id }}
          path: |
            openwrt/bin/targets/**/*
            openwrt/bin/packages/**/docker*.ipk
          retention-days: 30

      - name: æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "æ¸…ç†å·¥ä½œç©ºé—´..."
          if [ -d "openwrt" ]; then
            echo "æ¸…ç†openwrtæž„å»ºç›®å½•..."
            rm -rf openwrt/build_dir openwrt/staging_dir openwrt/tmp 2>/dev/null || true
            echo "å·¥ä½œç©ºé—´æ¸…ç†å®Œæˆ"
          else
            echo "openwrtç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å·¥ä½œç©ºé—´æ¸…ç†"
          fi

      - name: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        if: always()
        run: |
          echo "=== ç¼–è¯‘å®ŒæˆæŠ¥å‘Š ===" > build-report.txt
          echo "æ—¶é—´: $(date)" >> build-report.txt
          echo "å·¥ä½œæµç»“æžœ: ${{ job.status }}" >> build-report.txt
          echo "æœ€ç»ˆç£ç›˜ç©ºé—´:" >> build-report.txt
          df -h >> build-report.txt
          
          if [ -d "openwrt" ]; then
            echo "ç¼–è¯‘äº§ç‰©:" >> build-report.txt
            find openwrt/bin -name "*.bin" -exec echo "å›ºä»¶: {}" \; >> build-report.txt 2>/dev/null || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶" >> build-report.txt
          else
            echo "openwrtç›®å½•ä¸å­˜åœ¨" >> build-report.txt
          fi
          
          cat build-report.txt
