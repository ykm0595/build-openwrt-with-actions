name: ðŸš€ ç¼–è¯‘ ImmortalWrt for SL-3000 (æ— USBç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      skip_kmods:
        description: "è·³è¿‡å†…æ ¸æ¨¡å—ç¼–è¯‘ï¼ˆèŠ‚çœç©ºé—´ï¼‰"
        type: boolean
        default: false
      minimal_build:
        description: "æœ€å°åŒ–ç¼–è¯‘ï¼ˆä»…æ ¸å¿ƒ+Dockerï¼‰"
        type: boolean
        default: true
      clean_build:
        description: "å®Œå…¨æ¸…ç†æž„å»º"
        type: boolean
        default: false

env:
  REPO_URL: "https://github.com/immortalwrt/immortalwrt"
  BRANCH: "openwrt-24.10"
  TZ: "Asia/Shanghai"

jobs:
  build:
    runs-on: ubuntu-22.04
    name: ðŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶ (æ— USBç‰ˆ)
    timeout-minutes: 180
    
    steps:
      - name: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
          df -h
          echo "==================="

      - name: æ·±åº¦ç£ç›˜æ¸…ç†
        run: |
          echo "æ‰§è¡Œæ·±åº¦ç£ç›˜æ¸…ç†..."
          sudo apt autoremove -y
          sudo apt autoclean
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /usr/local/lib/android /opt/hostedtoolcache/CodeQL /usr/share/dotnet 2>/dev/null || true
          sudo rm -rf /opt/ghc /opt/hostedtoolcache/PyPy /opt/microsoft 2>/dev/null || true
          docker system prune -af 2>/dev/null || true
          sudo rm -rf /var/lib/docker/* 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* /var/cache/* ~/.cache/*
          sudo journalctl --vacuum-time=1h 2>/dev/null || true
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null || true
          echo "æ¸…ç†å®Œæˆ"

      - name: æ›´æ–°è½¯ä»¶æºå¹¶å®‰è£…ä¾èµ–
        run: |
          echo "æ›´æ–°è½¯ä»¶æºå¹¶å®‰è£…ä¾èµ–..."
          sudo apt update
          sudo apt upgrade -y
          
          # æ·»åŠ  universe å’Œ multiverse ä»“åº“
          sudo apt install -y software-properties-common
          sudo add-apt-repository -y universe
          sudo add-apt-repository -y multiverse
          sudo apt update
          
          # å®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·
          sudo apt install -y --no-install-recommends \
            build-essential ccache cmake curl flex gawk gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync subversion unzip wget zlib1g-dev \
            gcc-multilib g++-multilib pkg-config autoconf automake libtool \
            device-tree-compiler lld llvm ninja-build upx-ucl zstd \
            file gperf help2man texinfo xsltproc
          
          # å®‰è£… OpenWrt ç‰¹å®šä¾èµ–ï¼ˆä½¿ç”¨å¯ç”¨çš„åŒ…åï¼‰
          sudo apt install -y \
            libjson-c-dev libpcre2-dev libmbedtls-dev libsodium-dev \
            libc-ares-dev libcurl4-openssl-dev libxml2-dev libsqlite3-dev
          
          # å°è¯•å®‰è£…å¯èƒ½åç§°ä¸åŒçš„åŒ…
          sudo apt install -y libubox-dev || echo "libubox-dev ä¸å¯ç”¨ï¼Œå°†åœ¨ç¼–è¯‘æ—¶æž„å»º"
          sudo apt install -y libubus-dev || echo "libubus-dev ä¸å¯ç”¨ï¼Œå°†åœ¨ç¼–è¯‘æ—¶æž„å»º"
          
          # å®‰è£…å…¶ä»–å¯èƒ½éœ€è¦çš„ä¾èµ–
          sudo apt install -y \
            asciidoc bash-completion bison bzip2 diffutils fastjar findutils \
            genisoimage gzip libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libpopt-dev libreadline-dev libtool-bin \
            libyaml-dev make patch perl pkg-config poppler-utils python2.7-dev \
            qemu-utils re2c scons squashfs-tools time unar util-linux vim xxd
          
          # æ¸…ç†APTç¼“å­˜
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: è®¾ç½®ccacheä¼˜åŒ–
        run: |
          ccache -M 1G 2>/dev/null || true
          git config --global pack.windowMemory 50m
          git config --global pack.packSizeLimit 50m
          git config --global core.compression 9

      - name: å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æµ…å…‹éš† ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ env.BRANCH }}
          path: openwrt
          fetch-depth: 1

      - name: éªŒè¯æºç ç›®å½•
        run: |
          echo "=== éªŒè¯ openwrt ç›®å½• ==="
          if [ -d "openwrt" ]; then
            echo "âœ… openwrt ç›®å½•å­˜åœ¨"
            ls -la openwrt/
          else
            echo "âŒ openwrt ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºç›®å½•"
            mkdir -p openwrt
          fi

      - name: ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
          df -h
          AVAILABLE=$(df / --output=avail | tail -1)
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE}KB"
          if [ $AVAILABLE -lt 8000000 ]; then
            echo "è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼ ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
          else
            echo "ç£ç›˜ç©ºé—´å……è¶³"
          fi

      - name: åº”ç”¨æ— USBé…ç½®
        run: |
          echo "åº”ç”¨æ— USBé…ç½®..."
          mkdir -p openwrt
          # ä½¿ç”¨é€è¡Œechoå†™å…¥é…ç½®ï¼Œé¿å…å¤šè¡Œå­—ç¬¦ä¸²é—®é¢˜
          echo "CONFIG_TARGET_mediatek=y" > openwrt/.config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> openwrt/.config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_sl_3000-emmc=y" >> openwrt/.config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> openwrt/.config
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=n" >> openwrt/.config
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=32" >> openwrt/.config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> openwrt/.config
          echo "CONFIG_PACKAGE_block-mount=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_uhttpd=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_fstools=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_procd=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_uci=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_ubus=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_ubox=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-mt7915e=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-mt7916-firmware=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-mtk-esw-rt3050=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-mtk-hnat=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-mtk-ppe=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-phy-mediatek-ge-soc=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_dnsmasq=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_dnsmasq-full=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_firewall=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_odhcpd=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_odhcp6c=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_iptables=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_ip6tables=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_docker=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_dockerd=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_libdevmapper=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_libltdl=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-dm=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-br-netfilter=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-veth=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-ipt-nat=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-nf-conntrack=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-fuse=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-loop=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_luci=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_luci-ssl-openssl=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_luci-app-firewall=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_curl=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_bash=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_python3=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> openwrt/.config
          echo "CONFIG_PACKAGE_kmod-fs-squashfs=y" >> openwrt/.config
          echo "CONFIG_CCACHE=y" >> openwrt/.config
          echo "CONFIG_BUILD_LOG=y" >> openwrt/.config
          echo "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"

      - name: æ›´æ–°feeds
        run: |
          echo "æ›´æ–°feeds..."
          if [ -d "openwrt" ]; then
            cd openwrt
            ./scripts/feeds update -a
            ./scripts/feeds install -a
            echo "feedsæ›´æ–°å®Œæˆ"
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: é…ç½®æ£€æŸ¥
        run: |
          echo "åº”ç”¨é…ç½®ä¼˜åŒ–..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make defconfig
            ./scripts/diffconfig.sh > diffconfig.txt
            echo "é…ç½®ä¼˜åŒ–å®Œæˆ"
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ä¸‹è½½æºç 
        run: |
          echo "ä¸‹è½½æºç ..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make download -j2 V=0 || make download -j1 V=0
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç¼–è¯‘å·¥å…·é“¾
        run: |
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make tools/compile -j1 V=0
            make toolchain/compile -j1 V=0
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ
        run: |
          echo "ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ..."
          if [ -d "openwrt" ]; then
            cd openwrt
            if [ "${{ inputs.minimal_build }}" = "true" ]; then
              echo "ä½¿ç”¨æœ€å°åŒ–ç¼–è¯‘æ¨¡å¼..."
              make -j2 V=s
            else
              make -j$(nproc) V=s
            fi
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç¼–è¯‘Dockerç»„ä»¶
        if: ${{ !inputs.skip_kmods }}
        run: |
          echo "ç¼–è¯‘Dockerç»„ä»¶..."
          if [ -d "openwrt" ]; then
            cd openwrt
            make package/feeds/packages/docker/compile V=s -j2
            make package/feeds/packages/dockerd/compile V=s -j2
          else
            echo "é”™è¯¯: openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: éªŒè¯ç¼–è¯‘ç»“æžœ
        run: |
          echo "æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
          if [ -d "openwrt" ]; then
            cd openwrt
            if find bin/targets -name "*sl_3000*" 2>/dev/null | grep -q .; then
              echo "âœ… SL-3000å›ºä»¶ç¼–è¯‘æˆåŠŸ"
              find bin/targets -name "*sl_3000*.bin" -exec echo "å›ºä»¶: {}" \;
            else
              echo "âŒ æœªæ‰¾åˆ°SL-3000å›ºä»¶"
              echo "å½“å‰ç›®å½•å†…å®¹:"
              ls -la bin/targets/ 2>/dev/null || echo "bin/targetsç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ openwrtç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯ç¼–è¯‘ç»“æžœ"
            exit 1
          fi

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-nousb-${{ github.run_id }}
          path: |
            openwrt/bin/targets/**/*
            openwrt/bin/packages/**/docker*.ipk
          retention-days: 30

      - name: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        if: always()
        run: |
          echo "=== ç¼–è¯‘å®ŒæˆæŠ¥å‘Š ===" > build-report.txt
          echo "æ—¶é—´: $(date)" >> build-report.txt
          echo "å·¥ä½œæµç»“æžœ: ${{ job.status }}" >> build-report.txt
          echo "æœ€ç»ˆç£ç›˜ç©ºé—´:" >> build-report.txt
          df -h >> build-report.txt
          
          if [ -d "openwrt" ]; then
            echo "ç¼–è¯‘äº§ç‰©:" >> build-report.txt
            find openwrt/bin -name "*.bin" -exec echo "å›ºä»¶: {}" \; >> build-report.txt 2>/dev/null || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶" >> build-report.txt
          else
            echo "openwrtç›®å½•ä¸å­˜åœ¨" >> build-report.txt
          fi
          
          cat build-report.txt
