name: ðŸš€ ç¼–è¯‘ ImmortalWrt for SL-3000 (æ— USBç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      skip_kmods:
        description: "è·³è¿‡å†…æ ¸æ¨¡å—ç¼–è¯‘ï¼ˆèŠ‚çœç©ºé—´ï¼‰"
        type: boolean
        default: false
      minimal_build:
        description: "æœ€å°åŒ–ç¼–è¯‘ï¼ˆä»…æ ¸å¿ƒ+Dockerï¼‰"
        type: boolean
        default: true
      clean_build:
        description: "å®Œå…¨æ¸…ç†æž„å»º"
        type: boolean
        default: false

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    name: ðŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶ (æ— USBç‰ˆ)
    timeout-minutes: 180
    
    steps:
      - name: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
          df -h
          echo "=== å¤§ç›®å½•åˆ†æž ==="
          sudo du -sh /opt/* /usr/local/* /var/lib/docker 2>/dev/null | sort -hr | head -10 || true
          echo "==================="

      - name: æ·±åº¦ç£ç›˜æ¸…ç†
        run: |
          echo "æ‰§è¡Œæ·±åº¦ç£ç›˜æ¸…ç†..."
          sudo apt autoremove -y
          sudo apt autoclean
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /usr/local/lib/android /opt/hostedtoolcache/CodeQL /usr/share/dotnet 2>/dev/null || true
          sudo rm -rf /opt/ghc /opt/hostedtoolcache/PyPy /opt/microsoft 2>/dev/null || true
          docker system prune -af 2>/dev/null || true
          sudo rm -rf /var/lib/docker/* 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* /var/cache/* ~/.cache/*
          sudo journalctl --vacuum-time=1h 2>/dev/null || true
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null || true
          echo "æ¸…ç†å®Œæˆ"

      - name: æ¸…ç†åŽç©ºé—´æ£€æŸ¥
        run: |
          echo "=== æ¸…ç†åŽç£ç›˜ç©ºé—´ ==="
          df -h
          AVAILABLE=$(df / --output=avail | tail -1)
          REQUIRED=15000000
          if [ $AVAILABLE -lt $REQUIRED ]; then
            echo "é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³! éœ€è¦15GBï¼Œå½“å‰åªæœ‰ ${AVAILABLE}KB"
            sudo rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/locale/* 2>/dev/null || true
          fi
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE}KB"

      - name: å®‰è£…ç²¾ç®€ç‰ˆä¾èµ–
        run: |
          echo "å®‰è£…æœ€å°åŒ–ç¼–è¯‘ä¾èµ–..."
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential ccache cmake curl flex gawk gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync subversion unzip wget zlib1g-dev \
            libjson-c-dev libubox-dev libubus-dev libpcre2-dev \
            libmbedtls-dev libsodium-dev libc-ares-dev \
            gcc-multilib g++-multilib pkg-config autoconf automake libtool \
            device-tree-compiler lld llvm ninja-build upx-ucl zstd \
            file gperf help2man texinfo xsltproc
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: è®¾ç½®ccacheä¼˜åŒ–
        run: |
          ccache -M 1G 2>/dev/null || true
          git config --global pack.windowMemory 50m
          git config --global pack.packSizeLimit 50m
          git config --global core.compression 9

      - name: å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æµ…å…‹éš† ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ env.BRANCH }}
          path: openwrt
          fetch-depth: 1

      - name: ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
          df -h
          AVAILABLE=$(df / --output=avail | tail -1)
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE}KB"
          if [ $AVAILABLE -lt 8000000 ]; then
            echo "è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼ ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
          else
            echo "ç£ç›˜ç©ºé—´å……è¶³"
          fi

      - name: åº”ç”¨æ— USBé…ç½®
        run: |
          echo "åº”ç”¨æ— USBé…ç½®..."
          mkdir -p openwrt
          # ä½¿ç”¨ç®€å•çš„é…ç½®å†™å…¥æ–¹å¼ï¼Œé¿å…å¤æ‚çš„å¤šè¡Œå­—ç¬¦ä¸²
          cat > openwrt/.config << 'CONFIG_EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_sl_3000-emmc=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_EXT4FS=n
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_TARGET_ROOTFS_PARTSIZE=1024
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_uhttpd=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubox=y
CONFIG_PACKAGE_kmod-mt7915e=y
CONFIG_PACKAGE_kmod-mt7916-firmware=y
CONFIG_PACKAGE_kmod-mtk-esw-rt3050=y
CONFIG_PACKAGE_kmod-mtk-hnat=y
CONFIG_PACKAGE_kmod-mtk-ppe=y
CONFIG_PACKAGE_kmod-phy-mediatek-ge-soc=y
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcpd=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_ip6tables=y
CONFIG_PACKAGE_docker=y
CONFIG_PACKAGE_dockerd=y
CONFIG_PACKAGE_docker-compose=y
CONFIG_PACKAGE_containerd=y
CONFIG_PACKAGE_runc=y
CONFIG_PACKAGE_libdevmapper=y
CONFIG_PACKAGE_libltdl=y
CONFIG_PACKAGE_libnetwork=y
CONFIG_PACKAGE_libstdcpp=y
CONFIG_PACKAGE_kmod-dm=y
CONFIG_PACKAGE_kmod-br-netfilter=y
CONFIG_PACKAGE_kmod-veth=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-nat=y
CONFIG_PACKAGE_kmod-fuse=y
CONFIG_PACKAGE_kmod-loop=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl-openssl=y
CONFIG_PACKAGE_luci-app-dockerman=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_python3=y
CONFIG_PACKAGE_python3-pip=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-fs-squashfs=y
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
CONFIG_EOF
          echo "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"

      - name: æ›´æ–°feeds
        working-directory: openwrt
        run: |
          echo "æ›´æ–°feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: é…ç½®æ£€æŸ¥
        working-directory: openwrt
        run: |
          echo "åº”ç”¨é…ç½®ä¼˜åŒ–..."
          make defconfig
          ./scripts/diffconfig.sh > diffconfig.txt
          echo "é…ç½®ä¼˜åŒ–å®Œæˆ"

      - name: ä¸‹è½½æºç 
        working-directory: openwrt
        run: |
          echo "ä¸‹è½½æºç ..."
          make download -j2 V=0 || make download -j1 V=0

      - name: ç¼–è¯‘å·¥å…·é“¾
        working-directory: openwrt
        run: |
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make tools/compile -j1 V=0
          make toolchain/compile -j1 V=0

      - name: ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ
        working-directory: openwrt
        run: |
          echo "ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ..."
          if [ "${{ inputs.minimal_build }}" = "true" ]; then
            echo "ä½¿ç”¨æœ€å°åŒ–ç¼–è¯‘æ¨¡å¼..."
            make -j2 V=s
          else
            make -j$(nproc) V=s
          fi

      - name: ç¼–è¯‘Dockerç»„ä»¶
        working-directory: openwrt
        if: ${{ !inputs.skip_kmods }}
        run: |
          echo "ç¼–è¯‘Dockerç»„ä»¶..."
          make package/feeds/packages/docker/compile V=s -j2
          make package/feeds/packages/dockerd/compile V=s -j2

      - name: ç©ºé—´ç›‘æŽ§
        run: |
          echo "ç¼–è¯‘ä¸­ç£ç›˜ç©ºé—´:"
          df -h

      - name: æ¸…ç†ä¸­é—´æ–‡ä»¶
        if: always()
        working-directory: openwrt
        run: |
          echo "æ¸…ç†ä¸­é—´æ–‡ä»¶..."
          find build_dir -name "*.o" -delete 2>/dev/null || true
          find build_dir -name "*.a" -delete 2>/dev/null || true
          rm -rf logs/* tmp/* 2>/dev/null || true

      - name: éªŒè¯ç¼–è¯‘ç»“æžœ
        working-directory: openwrt
        run: |
          echo "æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
          if find bin/targets -name "*sl_3000*" | grep -q .; then
            echo "SL-3000å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            find bin/targets -name "*sl_3000*.bin" -exec echo "å›ºä»¶: {}" \;
          else
            echo "æœªæ‰¾åˆ°SL-3000å›ºä»¶"
            exit 1
          fi

      - name: æœ€ç»ˆç©ºé—´æŠ¥å‘Š
        run: |
          echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
          df -h

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-nousb-${{ github.run_id }}
          path: |
            openwrt/bin/targets/**/*
            openwrt/bin/packages/**/docker*.ipk
          retention-days: 30

      - name: æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "æ¸…ç†å·¥ä½œç©ºé—´..."
          rm -rf openwrt/build_dir openwrt/staging_dir openwrt/tmp 2>/dev/null || true

      - name: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        run: |
          echo "ç¼–è¯‘å®ŒæˆæŠ¥å‘Š" > build-report.txt
          echo "æ—¶é—´: $(date)" >> build-report.txt
          df -h >> build-report.txt
          find openwrt/bin -name "*.bin" -exec echo "å›ºä»¶: {}" \; >> build-report.txt 2>/dev/null || true
