name: ðŸš€ ç¼–è¯‘ ImmortalWrt for SL-3000 (æ— USBç‰ˆ) - ä¼˜åŒ–ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      skip_kmods:
        description: "è·³è¿‡å†…æ ¸æ¨¡å—ç¼–è¯‘ï¼ˆèŠ‚çœç©ºé—´ï¼‰"
        type: boolean
        default: true  # é»˜è®¤æ”¹ä¸ºtrueï¼Œå‡å°‘ç¼–è¯‘é‡
      minimal_build:
        description: "æœ€å°åŒ–ç¼–è¯‘ï¼ˆä»…æ ¸å¿ƒ+Dockerï¼‰"
        type: boolean
        default: true
      clean_build:
        description: "å®Œå…¨æ¸…ç†æž„å»º"
        type: boolean
        default: false

env:
  REPO_URL: "https://github.com/immortalwrt/immortalwrt"
  BRANCH: "openwrt-24.10"
  TZ: "Asia/Shanghai"

jobs:
  build:
    runs-on: ubuntu-22.04
    name: ðŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶ (æ— USBç‰ˆ)
    timeout-minutes: 180
    
    steps:
      - name: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
          df -h
          echo "==================="

      - name: æ·±åº¦ç£ç›˜æ¸…ç†
        run: |
          echo "æ‰§è¡Œæ·±åº¦ç£ç›˜æ¸…ç†..."
          sudo apt autoremove -y
          sudo apt autoclean
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /usr/local/lib/android /opt/hostedtoolcache/CodeQL /usr/share/dotnet 2>/dev/null || true
          sudo rm -rf /opt/ghc /opt/hostedtoolcache/PyPy /opt/microsoft 2>/dev/null || true
          docker system prune -af 2>/dev/null || true
          sudo rm -rf /var/lib/docker/* 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* /var/cache/* ~/.cache/*
          sudo journalctl --vacuum-time=1h 2>/dev/null || true
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null || true
          echo "æ¸…ç†å®Œæˆ"

      - name: å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆæœ€å°åŒ–ï¼‰
        run: |
          echo "å®‰è£…æ ¸å¿ƒç¼–è¯‘ä¾èµ–..."
          sudo apt update
          
          # åªå®‰è£…æœ€æ ¸å¿ƒçš„ç¼–è¯‘å·¥å…·
          sudo apt install -y --no-install-recommends \
            build-essential ccache curl file gawk gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync unzip wget zlib1g-dev \
            gcc-multilib g++-multilib pkg-config autoconf automake libtool \
            device-tree-compiler lld llvm ninja-build \
            gperf help2man texinfo xsltproc \
            asciidoc bison bzip2 diffutils findutils \
            gzip make patch perl re2c scons squashfs-tools time xxd
          
          # æ¸…ç†APTç¼“å­˜
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          echo "æ ¸å¿ƒä¾èµ–å®‰è£…å®Œæˆ"

      - name: è®¾ç½®ç¼–è¯‘ä¼˜åŒ–
        run: |
          # è®¾ç½®ccache
          ccache -M 2G 2>/dev/null || true
          # ä¼˜åŒ–gitè®¾ç½®å‡å°‘å†…å­˜ä½¿ç”¨
          git config --global pack.windowMemory 50m
          git config --global pack.packSizeLimit 50m
          git config --global core.compression 9
          git config --global core.packedGitLimit 128m
          git config --global core.packedGitWindowSize 16m
          # è®¾ç½®ulimité¿å…å†…å­˜ä¸è¶³
          ulimit -s 32768 2>/dev/null || true

      - name: å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æµ…å…‹éš† ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ env.BRANCH }}
          path: openwrt
          fetch-depth: 1

      - name: éªŒè¯æºç ç›®å½•
        run: |
          echo "=== éªŒè¯ openwrt ç›®å½• ==="
          if [ -d "openwrt" ]; then
            echo "âœ… openwrt ç›®å½•å­˜åœ¨"
            ls -la openwrt/
          else
            echo "âŒ openwrt ç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•å®Œæ•´å…‹éš†"
            git clone --depth=1 $REPO_URL -b $BRANCH openwrt
          fi

      - name: ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
          df -h
          AVAILABLE=$(df / --output=avail | tail -1)
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE}KB"
          if [ $AVAILABLE -lt 10000000 ]; then
            echo "âš ï¸ ç£ç›˜ç©ºé—´ç´§å¼ ï¼Œå¯ç”¨æžç®€ç¼–è¯‘æ¨¡å¼"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
          fi

      - name: åº”ç”¨æ— USBé…ç½®
        run: |
          echo "åº”ç”¨æ— USBé…ç½®..."
          mkdir -p openwrt
          cat > openwrt/.config << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_sl_3000-emmc=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_EXT4FS=n
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_TARGET_ROOTFS_PARTSIZE=1024
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
CONFIG_SINGLE_IMAGE=y
# æ ¸å¿ƒåŒ…
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_uhttpd=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubox=y
# ç½‘ç»œé©±åŠ¨
CONFIG_PACKAGE_kmod-mt7915e=y
CONFIG_PACKAGE_kmod-mt7916-firmware=y
CONFIG_PACKAGE_kmod-mtk-esw-rt3050=y
CONFIG_PACKAGE_kmod-mtk-hnat=y
CONFIG_PACKAGE_kmod-mtk-ppe=y
CONFIG_PACKAGE_kmod-phy-mediatek-ge-soc=y
# ç½‘ç»œæœåŠ¡
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcpd=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_ip6tables=y
# Dockerç›¸å…³
CONFIG_PACKAGE_docker=y
CONFIG_PACKAGE_dockerd=y
CONFIG_PACKAGE_libdevmapper=y
CONFIG_PACKAGE_libltdl=y
CONFIG_PACKAGE_kmod-dm=y
CONFIG_PACKAGE_kmod-br-netfilter=y
CONFIG_PACKAGE_kmod-veth=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-nat=y
CONFIG_PACKAGE_kmod-fuse=y
CONFIG_PACKAGE_kmod-loop=y
# æ–‡ä»¶ç³»ç»Ÿ
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-squashfs=y
# Luci
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl-openssl=y
CONFIG_PACKAGE_luci-app-dockerman=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
# å·¥å…·
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_python3=y
EOF
          echo "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"

      - name: æ›´æ–°feedsï¼ˆç®€åŒ–ç‰ˆï¼‰
        run: |
          echo "æ›´æ–°feeds..."
          cd openwrt
          # åªæ›´æ–°åŸºç¡€feedsï¼Œè·³è¿‡éƒ¨åˆ†å¯é€‰åŒ…
          ./scripts/feeds update base packages luci
          ./scripts/feeds install -a
          echo "feedsæ›´æ–°å®Œæˆ"

      - name: é…ç½®æ£€æŸ¥
        run: |
          echo "åº”ç”¨é…ç½®ä¼˜åŒ–..."
          cd openwrt
          make defconfig
          ./scripts/diffconfig.sh > diffconfig.txt
          echo "=== æœ€ç»ˆé…ç½® ==="
          cat diffconfig.txt
          echo "é…ç½®ä¼˜åŒ–å®Œæˆ"

      - name: ä¸‹è½½æºç ï¼ˆå¸¦é‡è¯•ï¼‰
        run: |
          echo "ä¸‹è½½æºç ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰..."
          cd openwrt
          for i in {1..3}; do
            echo "ç¬¬ $i æ¬¡å°è¯•ä¸‹è½½..."
            if make download -j2 V=0; then
              echo "âœ… ä¸‹è½½æˆåŠŸ"
              break
            else
              echo "âŒ ç¬¬ $i æ¬¡ä¸‹è½½å¤±è´¥"
              if [ $i -eq 3 ]; then
                echo "âš ï¸ æœ€ç»ˆä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ä¸‹è½½..."
                make download -j1 V=0 || true
              fi
              sleep 10
            fi
          done

      - name: ç¼–è¯‘å·¥å…·é“¾ï¼ˆåˆ†æ­¥è¿›è¡Œï¼‰
        run: |
          echo "ç¼–è¯‘å·¥å…·é“¾ï¼ˆåˆ†æ­¥è¿›è¡Œï¼‰..."
          cd openwrt
          # åˆ†æ­¥ç¼–è¯‘å·¥å…·é“¾ï¼Œé¿å…èµ„æºç«žäº‰
          echo "æ­¥éª¤1: ç¼–è¯‘åŸºç¡€å·¥å…·..."
          make tools/install -j1 V=0 || make tools/install -j1 V=s
          
          echo "æ­¥éª¤2: ç¼–è¯‘å·¥å…·é“¾..."
          make toolchain/install -j1 V=0 || make toolchain/install -j1 V=s
          
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        run: |
          echo "ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿï¼ˆä¼˜åŒ–ç‰ˆï¼‰..."
          cd openwrt
          
          # è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒå˜é‡ä¼˜åŒ–
          export MAKE_ARGS="-j2"
          export GLUON_DEPRECATED=1
          
          if [ "${{ github.event.inputs.minimal_build }}" = "true" ]; then
            echo "ä½¿ç”¨æœ€å°åŒ–ç¼–è¯‘æ¨¡å¼..."
            # åˆ†æ­¥ç¼–è¯‘ï¼Œé¿å…å¡ä½
            echo "1. ç¼–è¯‘å†…æ ¸..."
            make target/linux/install $MAKE_ARGS V=0
            
            echo "2. ç¼–è¯‘åŸºç¡€åŒ…..."
            make package/base-files/install $MAKE_ARGS V=0
            make package/kernel/linux/install $MAKE_ARGS V=0
            
            echo "3. ç¼–è¯‘ç³»ç»Ÿæ ¸å¿ƒ..."
            make package/system/opkg/install $MAKE_ARGS V=0
            make package/system/procd/install $MAKE_ARGS V=0
            
            echo "4. ç¼–è¯‘ç½‘ç»œæ ¸å¿ƒ..."
            make package/network/services/dnsmasq/install $MAKE_ARGS V=0
            make package/network/config/firewall/install $MAKE_ARGS V=0
            
            echo "5. æœ€ç»ˆç¼–è¯‘..."
            make $MAKE_ARGS V=0 || make -j1 V=s
          else
            echo "ä½¿ç”¨æ ‡å‡†ç¼–è¯‘æ¨¡å¼..."
            make $MAKE_ARGS V=0 || make -j1 V=s
          fi

      - name: ç¼–è¯‘Dockerç»„ä»¶ï¼ˆæ¡ä»¶ç¼–è¯‘ï¼‰
        if: ${{ !inputs.skip_kmods }}
        run: |
          echo "ç¼–è¯‘Dockerç»„ä»¶..."
          cd openwrt
          # å•ç‹¬ç¼–è¯‘Dockerç›¸å…³åŒ…
          for pkg in docker dockerd libdevmapper libltdl; do
            echo "ç¼–è¯‘åŒ…: $pkg"
            make package/feeds/packages/$pkg/compile -j1 V=0 || \
            make package/feeds/packages/$pkg/compile -j1 V=s
          done

      - name: ç©ºé—´æ¸…ç†ï¼ˆç¼–è¯‘åŽï¼‰
        run: |
          echo "ç¼–è¯‘åŽæ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          cd openwrt
          # æ¸…ç†ç¼–è¯‘ä¸­é—´æ–‡ä»¶ï¼Œä¿ç•™æœ€ç»ˆäº§ç‰©
          if [ -d "build_dir" ]; then
            find build_dir -name "*.o" -delete 2>/dev/null || true
            find build_dir -name "*.a" -delete 2>/dev/null || true
            find build_dir -name "*.lo" -delete 2>/dev/null || true
          fi
          echo "æ¸…ç†å®Œæˆ"

      - name: éªŒè¯ç¼–è¯‘ç»“æžœ
        run: |
          echo "æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
          if [ -d "openwrt" ]; then
            cd openwrt
            if find bin/targets -name "*sl_3000*" -o -name "*sl3000*" 2>/dev/null | grep -q .; then
              echo "âœ… SL-3000å›ºä»¶ç¼–è¯‘æˆåŠŸ"
              find bin/targets -name "*.bin" -exec echo "å›ºä»¶: {}" \;
              # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
              find bin/targets -name "*.bin" -exec ls -lh {} \;
            else
              echo "âŒ æœªæ‰¾åˆ°SL-3000å›ºä»¶"
              echo "å½“å‰ç›®å½•å†…å®¹:"
              ls -la bin/targets/ 2>/dev/null || echo "bin/targetsç›®å½•ä¸å­˜åœ¨"
              # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–äº§ç‰©
              find bin -name "*.bin" -o -name "*.img" 2>/dev/null | head -10
              exit 1
            fi
          else
            echo "âŒ openwrtç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-nousb-${{ github.run_id }}
          path: |
            openwrt/bin/targets/**/*.bin
            openwrt/bin/targets/**/*.manifest
            openwrt/bin/packages/**/docker*.ipk
          retention-days: 30
          compression-level: 0  # ç¦ç”¨åŽ‹ç¼©ï¼ŒèŠ‚çœæ—¶é—´

      - name: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        if: always()
        run: |
          {
            echo "=== ç¼–è¯‘å®ŒæˆæŠ¥å‘Š ==="
            echo "æ—¶é—´: $(date)"
            echo "å·¥ä½œæµç»“æžœ: ${{ job.status }}"
            echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
            df -h
            echo "ç¼–è¯‘é…ç½®:"
            echo "  - æœ€å°åŒ–ç¼–è¯‘: ${{ github.event.inputs.minimal_build }}"
            echo "  - è·³è¿‡å†…æ ¸æ¨¡å—: ${{ github.event.inputs.skip_kmods }}"
            if [ -d "openwrt" ]; then
              echo "ç¼–è¯‘äº§ç‰©:"
              find openwrt/bin -name "*.bin" -exec echo "å›ºä»¶: {}" \; 2>/dev/null || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            else
              echo "openwrtç›®å½•ä¸å­˜åœ¨"
            fi
          } > build-report.txt
          
          cat build-report.txt
