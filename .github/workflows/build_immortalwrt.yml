name: ðŸš€ ç¼–è¯‘ ImmortalWrt for SL-3000 (å«Docker)

on:
  workflow_dispatch:
    inputs:
      skip_kmods:
        description: "è·³è¿‡å†…æ ¸æ¨¡å—ç¼–è¯‘ï¼ˆèŠ‚çœç©ºé—´ï¼‰"
        type: boolean
        default: false
      minimal_build:
        description: "æœ€å°åŒ–ç¼–è¯‘ï¼ˆä»…æ ¸å¿ƒ+Dockerï¼‰"
        type: boolean
        default: true
      clean_build:
        description: "å®Œå…¨æ¸…ç†æž„å»º"
        type: boolean
        default: false

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    name: ðŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶ (ç£ç›˜ä¼˜åŒ–ç‰ˆ)
    timeout-minutes: 180
    
    steps:
      - name: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
        run: |
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
          df -h
          echo "=== å¤§ç›®å½•åˆ†æž ==="
          sudo du -sh /opt/* /usr/local/* /var/lib/docker 2>/dev/null | sort -hr | head -10 || true
          echo "==================="

      - name: æ·±åº¦ç£ç›˜æ¸…ç†
        run: |
          echo "æ‰§è¡Œæ·±åº¦ç£ç›˜æ¸…ç†..."
          
          # APT æ¸…ç†
          sudo apt autoremove -y
          sudo apt autoclean
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*
          
          # åˆ é™¤å¤§åž‹å¼€å‘å·¥å…·åŒ…
          sudo rm -rf /usr/local/lib/android 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet 2>/dev/null || true
          sudo rm -rf /opt/ghc 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache/PyPy 2>/dev/null || true
          sudo rm -rf /opt/microsoft 2>/dev/null || true
          
          # Docker æ¸…ç†
          docker system prune -af 2>/dev/null || true
          sudo rm -rf /var/lib/docker/* 2>/dev/null || true
          
          # ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶æ¸…ç†
          sudo rm -rf /tmp/*
          sudo rm -rf /var/tmp/*
          sudo rm -rf /var/cache/*
          sudo rm -rf ~/.cache/*
          
          # æ—¥å¿—æ¸…ç†
          sudo journalctl --vacuum-time=1h 2>/dev/null || true
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null || true
          
          echo "æ¸…ç†å®Œæˆ"

      - name: æ¸…ç†åŽç©ºé—´æ£€æŸ¥
        run: |
          echo "=== æ¸…ç†åŽç£ç›˜ç©ºé—´ ==="
          df -h
          AVAILABLE=$(df / --output=avail | tail -1)
          REQUIRED=15000000  # 15GB
          if [ $AVAILABLE -lt $REQUIRED ]; then
            echo "âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³! éœ€è¦15GBï¼Œå½“å‰åªæœ‰ ${AVAILABLE}KB"
            echo "å°è¯•è¿›ä¸€æ­¥æ¸…ç†..."
            # è¿›ä¸€æ­¥æ¸…ç†
            sudo rm -rf /usr/share/doc/* 2>/dev/null || true
            sudo rm -rf /usr/share/man/* 2>/dev/null || true
            sudo rm -rf /usr/share/locale/* 2>/dev/null || true
          fi
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE}KB"

      - name: å®‰è£…ç²¾ç®€ç‰ˆä¾èµ–
        run: |
          echo "å®‰è£…æœ€å°åŒ–ç¼–è¯‘ä¾èµ–..."
          sudo apt update
          # åªå®‰è£…æ ¸å¿ƒç¼–è¯‘å·¥å…·ï¼Œé¿å…ä¸å¿…è¦çš„æ–‡æ¡£å’ŒæŽ¨èåŒ…
          sudo apt install -y --no-install-recommends \
            build-essential ccache cmake curl flex gawk gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync subversion unzip wget zlib1g-dev \
            libjson-c-dev libubox-dev libubus-dev libpcre2-dev \
            libmbedtls-dev libsodium-dev libc-ares-dev \
            gcc-multilib g++-multilib pkg-config autoconf automake libtool \
            device-tree-compiler lld llvm ninja-build upx-ucl zstd \
            file gperf help2man texinfo xsltproc

          # å®‰è£…åŽç«‹å³æ¸…ç†APTç¼“å­˜
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: è®¾ç½®ccacheä¼˜åŒ–
        run: |
          # è®¾ç½®ccacheå¤§å°é™åˆ¶
          ccache -M 1G 2>/dev/null || true
          # è®¾ç½®Gitä¼˜åŒ–å‡å°‘ç©ºé—´å ç”¨
          git config --global pack.windowMemory 50m
          git config --global pack.packSizeLimit 50m
          git config --global core.compression 9

      - name: å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          # æµ…å…‹éš†èŠ‚çœç©ºé—´
          fetch-depth: 1

      - name: æµ…å…‹éš† ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ env.BRANCH }}
          path: openwrt
          # æµ…å…‹éš†ï¼ŒåªèŽ·å–æœ€æ–°æäº¤
          fetch-depth: 1

      - name: ç¼–è¯‘å‰ç©ºé—´ç¡®è®¤
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
          df -h
          AVAILABLE=$(df / --output=avail | tail -1)
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE}KB"
          if [ $AVAILABLE -lt 8000000 ]; then
            echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼ ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
          fi

      - name: å¤åˆ¶æœ€å°åŒ–é…ç½®
        run: |
          echo "åº”ç”¨æœ€å°åŒ–é…ç½®..."
          # åªå¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶
          [ -f .config ] && cp .config openwrt/ || echo "ç”Ÿæˆæœ€å°åŒ–é…ç½®"
          
          # ç¡®ä¿ä½¿ç”¨æœ€å°åŒ–é…ç½®
          if [ ! -f openwrt/.config ]; then
            cat > openwrt/.config << 'EOF'
# ç›®æ ‡ç³»ç»Ÿ - SL-3000
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_sl_3000-emmc=y

# é•œåƒè®¾ç½® - æœ€å°åŒ–
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_EXT4FS=n
CONFIG_TARGET_KERNEL_PARTSIZE=16
CONFIG_TARGET_ROOTFS_PARTSIZE=256

# åŸºç¡€ç³»ç»Ÿ - å¿…éœ€ç»„ä»¶
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_uhttpd=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubox=y

# å†…æ ¸æ¨¡å— - SL-3000æ ¸å¿ƒé©±åŠ¨
CONFIG_PACKAGE_kmod-mt7915e=y
CONFIG_PACKAGE_kmod-mt7916-firmware=y
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb3=y

# Dockeræ ¸å¿ƒ - æœ€å°åŒ–é€‰æ‹©
CONFIG_PACKAGE_docker=y
CONFIG_PACKAGE_dockerd=y
CONFIG_PACKAGE_libdevmapper=y
CONFIG_PACKAGE_libltdl=y

# Dockerå¿…éœ€å†…æ ¸æ¨¡å—
CONFIG_PACKAGE_kmod-dm=y
CONFIG_PACKAGE_kmod-br-netfilter=y
CONFIG_PACKAGE_kmod-veth=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-nat=y

# ç½‘ç»œåŸºç¡€
CONFIG_PACKAGE_wpad-basic=y
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_odhcp6c=y

# LuCIæœ€å°åŒ–
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl-openssl=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# å¿…éœ€å·¥å…·
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_bash=y

# æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_fdisk=y

# æž„å»ºè®¾ç½®
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
# ç¦ç”¨è°ƒè¯•ä¿¡æ¯ä»¥èŠ‚çœç©ºé—´
# CONFIG_DEBUG is not set
EOF
          fi

      - name: æ›´æ–°feeds (æœ€å°åŒ–)
        working-directory: openwrt
        run: |
          echo "æœ€å°åŒ–æ›´æ–°feeds..."
          # åªæ›´æ–°å¿…è¦çš„feeds
          ./scripts/feeds update base packages luci
          ./scripts/feeds install -a

      - name: é…ç½®æ£€æŸ¥å’Œä¼˜åŒ–
        working-directory: openwrt
        run: |
          echo "åº”ç”¨é…ç½®ä¼˜åŒ–..."
          make defconfig
          
          # è¿›ä¸€æ­¥ä¼˜åŒ–é…ç½®èŠ‚çœç©ºé—´
          ./scripts/diffconfig.sh >> diffconfig.txt
          echo "é…ç½®ä¼˜åŒ–å®Œæˆ"

      - name: åˆ†é˜¶æ®µä¸‹è½½æºç 
        working-directory: openwrt
        run: |
          echo "åˆ†é˜¶æ®µä¸‹è½½æºç ..."
          # å…ˆä¸‹è½½æ ¸å¿ƒåŒ…
          make toolchain/download -j2 V=0
          make package/base-files/download -j2 V=0
          # ç„¶åŽä¸‹è½½å‰©ä½™åŒ…
          make download -j2 V=0 || make download -j1 V=0

      - name: ç¼–è¯‘å·¥å…·é“¾ (ç©ºé—´ä¼˜åŒ–)
        working-directory: openwrt
        run: |
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          # å•çº¿ç¨‹ç¼–è¯‘å·¥å…·é“¾é¿å…å†…å­˜å’Œç£ç›˜åŽ‹åŠ›
          make tools/compile -j1 V=0
          make toolchain/compile -j1 V=0
          
          # ç¼–è¯‘åŽç«‹å³æ¸…ç†å·¥å…·é“¾ä¸­é—´æ–‡ä»¶
          find build_dir -name "*.o" -delete 2>/dev/null || true

      - name: ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ (ç©ºé—´ä¼˜åŒ–)
        working-directory: openwrt
        run: |
          echo "ç¼–è¯‘æ ¸å¿ƒç³»ç»Ÿ..."
          # ä½¿ç”¨è¾ƒå°‘çº¿ç¨‹ç¼–è¯‘ä»¥å‡å°‘å†…å­˜ä½¿ç”¨
          if [ "${{ inputs.minimal_build }}" = "true" ]; then
            echo "ä½¿ç”¨æœ€å°åŒ–ç¼–è¯‘æ¨¡å¼..."
            make -j2 V=s
          else
            make -j$(nproc) V=s
          fi

      - name: ç¼–è¯‘Dockerç»„ä»¶ (æ¡ä»¶ç¼–è¯‘)
        working-directory: openwrt
        if: ${{ !inputs.skip_kmods }}
        run: |
          echo "ç¼–è¯‘Dockerç»„ä»¶..."
          # åªç¼–è¯‘å¿…éœ€çš„Dockerç»„ä»¶
          make package/feeds/packages/docker/compile V=s -j2
          make package/feeds/packages/dockerd/compile V=s -j2

      - name: å®žæ—¶ç©ºé—´ç›‘æŽ§
        run: |
          echo "=== ç¼–è¯‘ä¸­ç£ç›˜ç©ºé—´ ==="
          df -h
          echo "=== ç¼–è¯‘ç›®å½•å¤§å° ==="
          du -sh openwrt/build_dir openwrt/staging_dir openwrt/tmp 2>/dev/null || true

      - name: æ¸…ç†ç¼–è¯‘ä¸­é—´æ–‡ä»¶
        if: always()
        working-directory: openwrt
        run: |
          echo "æ¸…ç†ä¸­é—´æ–‡ä»¶ä»¥èŠ‚çœç©ºé—´..."
          # æ¸…ç†ç¼–è¯‘ä¸­é—´æ–‡ä»¶ä½†ä¿ç•™æœ€ç»ˆäº§ç‰©
          find build_dir -name "*.o" -delete 2>/dev/null || true
          find build_dir -name "*.a" -delete 2>/dev/null || true
          rm -rf logs/* 2>/dev/null || true
          rm -rf tmp/* 2>/dev/null || true

      - name: éªŒè¯ç¼–è¯‘ç»“æžœ
        working-directory: openwrt
        run: |
          echo "æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
          find bin/targets -name "*.bin" -o -name "*.img" | head -10
          
          # æ£€æŸ¥äº§ç‰©å¤§å°
          echo "å›ºä»¶å¤§å°:"
          find bin/targets -name "*.bin" -exec du -h {} \; | head -5 || true
          
          if find bin/targets -name "*sl_3000*" | grep -q .; then
            echo "âœ… SL-3000å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            # æ˜¾ç¤ºæœ€ç»ˆå›ºä»¶ä¿¡æ¯
            find bin/targets -name "*sl_3000*.bin" -exec echo "æœ€ç»ˆå›ºä»¶: {}" \;
          else
            echo "âŒ æœªæ‰¾åˆ°SL-3000å›ºä»¶"
            exit 1
          fi

      - name: æœ€ç»ˆç©ºé—´æŠ¥å‘Š
        run: |
          echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´ ==="
          df -h
          echo "=== äº§ç‰©ç›®å½•å¤§å° ==="
          du -sh openwrt/bin || true

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-minimal-${{ github.run_id }}
          path: |
            openwrt/bin/targets/**/*
            openwrt/bin/packages/**/docker*.ipk
            openwrt/bin/packages/**/kmod-*.ipk
          retention-days: 30
          compression-level: 0

      - name: æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "æ¸…ç†å·¥ä½œç©ºé—´..."
          rm -rf openwrt/build_dir openwrt/staging_dir openwrt/tmp 2>/dev/null || true
          # ä¿ç•™binç›®å½•ç”¨äºŽä¸Šä¼ 

      - name: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        run: |
          echo "=== ç¼–è¯‘å®ŒæˆæŠ¥å‘Š ===" > build-report.txt
          echo "ç¼–è¯‘æ—¶é—´: $(date)" >> build-report.txt
          echo "æœ€ç»ˆç£ç›˜ç©ºé—´:" >> build-report.txt
          df -h >> build-report.txt
          echo "å›ºä»¶äº§ç‰©:" >> build-report.txt
          find openwrt/bin -name "*.bin" -exec echo "- {}" \; >> build-report.txt 2>/dev/null || true
          
          cat build-report.txt
