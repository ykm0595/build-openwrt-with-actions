#!/bin/bash
set -e

check_disk_space() {
    local required_gb=$1
    local available_kb=$(df / --output=avail | tail -1)
    local available_gb=$((available_kb / 1024 / 1024))
    
    echo "当前可用磁盘空间: ${available_gb}GB"
    echo "所需磁盘空间: ${required_gb}GB"
    
    if [ $available_gb -lt $required_gb ]; then
        echo "❌ 错误: 磁盘空间不足!"
        echo "请尝试:"
        echo "1. 删除不必要的软件包: sudo apt autoremove -y"
        echo "2. 清理缓存: sudo apt clean && sudo rm -rf /var/lib/apt/lists/*"
        echo "3. 删除Docker镜像: docker system prune -af"
        echo "4. 删除临时文件: sudo rm -rf /tmp/*"
        return 1
    fi
    return 0
}

# 检查各目录占用空间
analyze_disk_usage() {
    echo "=== 磁盘使用分析 ==="
    du -sh /opt/* /usr/local/* /var/lib/docker /var/cache 2>/dev/null | sort -hr | head -15
}

# 执行清理操作
cleanup_disk() {
    echo "开始清理磁盘..."
    
    # APT 清理
    sudo apt autoremove -y 2>/dev/null || true
    sudo apt clean 2>/dev/null || true
    
    # 缓存清理
    sudo rm -rf /var/lib/apt/lists/* 2>/dev/null || true
    sudo rm -rf /tmp/* 2>/dev/null || true
    sudo rm -rf /var/tmp/* 2>/dev/null || true
    
    # 日志清理
    sudo journalctl --vacuum-time=1d 2>/dev/null || true
    sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; 2>/dev/null || true
    
    # Docker 清理
    docker system prune -af 2>/dev/null || true
    
    echo "清理完成"
}

# 主函数
main() {
    local required_gb=${1:-10}
    
    analyze_disk_usage
    echo "---"
    
    if ! check_disk_space $required_gb; then
        echo "尝试自动清理..."
        cleanup_disk
        echo "---"
        check_disk_space $required_gb || exit 1
    fi
    
    echo "✅ 磁盘空间充足，可以开始编译"
}

main "$@"
